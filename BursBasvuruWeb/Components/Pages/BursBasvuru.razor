@page "/burs-basvuru"
@using Microsoft.AspNetCore.Components.Web
@using Microsoft.Data.SqlClient
@using System.Linq
@inject NavigationManager NavManager
@rendermode InteractiveServer

<PageTitle>Burs Başvuru Formu | Burs Vakfı</PageTitle>

<!-- Navbar -->
<header class="sticky top-0 z-50 w-full bg-surface-light/95 dark:bg-surface-dark/95 backdrop-blur border-b border-border-color dark:border-gray-800">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex items-center justify-between h-16">
            <!-- Logo -->
            <div class="flex items-center gap-3 cursor-pointer" @onclick="NavigateHome">
                <div class="bg-primary/10 p-2 rounded-lg text-primary">
                    <span class="material-symbols-outlined text-2xl">school</span>
                </div>
                <h1 class="text-xl font-bold tracking-tight text-text-main dark:text-white">Burs Vakfı</h1>
            </div>
            <!-- Nav Links (Desktop) -->
            <nav class="hidden md:flex items-center gap-8">
                <a class="text-sm font-medium text-text-main dark:text-gray-300 hover:text-primary transition-colors" href="/">Ana Sayfa</a>
                <a class="text-sm font-medium text-text-main dark:text-gray-300 hover:text-primary transition-colors" href="#">Burslar</a>
                <a class="text-sm font-medium text-text-main dark:text-gray-300 hover:text-primary transition-colors" href="#">Hakkımızda</a>
                <a class="text-sm font-medium text-text-main dark:text-gray-300 hover:text-primary transition-colors" href="#">İletişim</a>
            </nav>
        </div>
    </div>
</header>

<!-- Main Content Area -->
<main class="flex-grow py-12 px-4 sm:px-6 lg:px-8 bg-background-light dark:bg-background-dark">
    <div class="max-w-2xl mx-auto">
        <!-- Page Header -->
        <div class="mb-8 text-center">
            <h2 class="text-3xl sm:text-4xl font-black text-text-main dark:text-white tracking-tight mb-4">
                2024-2025 Dönemi Burs Başvurusu
            </h2>
            <p class="text-text-secondary dark:text-gray-400 text-lg leading-relaxed max-w-lg mx-auto">
                Geleceğinize yatırım yapmak için ilk adımı atın. Lütfen aşağıdaki formu eksiksiz ve doğru bilgilerle doldurunuz.
            </p>
        </div>

        @if (!string.IsNullOrEmpty(mesaj))
        {
            var alertClass = IsErrorMessage ? "bg-red-50 border-red-200 text-red-800 dark:bg-red-900/20 dark:border-red-800 dark:text-red-300" : "bg-green-50 border-green-200 text-green-800 dark:bg-green-900/20 dark:border-green-800 dark:text-green-300";
            <div class="@alertClass border rounded-xl p-4 flex items-center gap-3 mb-6">
                <span class="material-symbols-outlined">@(IsErrorMessage ? "error" : "check_circle")</span>
                <div>@mesaj</div>
            </div>
        }

        <!-- Application Form Card -->
        <div class="bg-surface-light dark:bg-surface-dark rounded-2xl shadow-xl border border-border-color dark:border-gray-700 overflow-hidden">
            <!-- Progress Indicator -->
            <div class="h-1.5 w-full bg-gray-100 dark:bg-gray-800">
                <div class="h-full bg-primary w-1/3 rounded-r-full"></div>
            </div>
            <form class="p-8 sm:p-10 flex flex-col gap-8" @onsubmit="HandleSubmit" @onsubmit:preventDefault>
                <!-- Section: Personal Info -->
                <div class="space-y-6">
                    <div class="flex items-center gap-2 mb-2 pb-2 border-b border-gray-100 dark:border-gray-800">
                        <span class="material-symbols-outlined text-primary">person</span>
                        <h3 class="text-lg font-bold text-text-main dark:text-white">Kişisel Bilgiler</h3>
                    </div>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
                        <!-- Ad Field -->
                        <div class="space-y-1.5">
                            <label class="block text-sm font-medium text-text-main dark:text-gray-300" for="ad">
                                Ad <span class="text-red-500">*</span>
                            </label>
                            <input class="block w-full rounded-lg border-input-border dark:border-gray-600 bg-background-light dark:bg-gray-800 text-text-main dark:text-white shadow-sm focus:border-primary focus:ring-primary sm:text-sm h-12 px-4 transition-colors" 
                                   id="ad" 
                                   placeholder="Adınız" 
                                   type="text"
                                   @bind="ad" />
                        </div>
                        <!-- Soyad Field -->
                        <div class="space-y-1.5">
                            <label class="block text-sm font-medium text-text-main dark:text-gray-300" for="soyad">
                                Soyad <span class="text-red-500">*</span>
                            </label>
                            <input class="block w-full rounded-lg border-input-border dark:border-gray-600 bg-background-light dark:bg-gray-800 text-text-main dark:text-white shadow-sm focus:border-primary focus:ring-primary sm:text-sm h-12 px-4 transition-colors" 
                                   id="soyad" 
                                   placeholder="Soyadınız" 
                                   type="text"
                                   @bind="soyad" />
                        </div>
                    </div>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
                        <!-- Email Field -->
                        <div class="space-y-1.5">
                            <label class="block text-sm font-medium text-text-main dark:text-gray-300" for="email">
                                E-posta Adresi <span class="text-red-500">*</span>
                            </label>
                            <input class="block w-full rounded-lg border-input-border dark:border-gray-600 bg-background-light dark:bg-gray-800 text-text-main dark:text-white shadow-sm focus:border-primary focus:ring-primary sm:text-sm h-12 px-4 transition-colors" 
                                   id="email" 
                                   placeholder="Örn: ahmet@ogrenci.edu.tr" 
                                   type="email"
                                   @bind="eposta" />
                        </div>
                        <!-- Phone Field -->
                        <div class="space-y-1.5">
                            <label class="block text-sm font-medium text-text-main dark:text-gray-300" for="phone">
                                Telefon Numarası <span class="text-red-500">*</span>
                            </label>
                            <input class="block w-full rounded-lg border-input-border dark:border-gray-600 bg-background-light dark:bg-gray-800 text-text-main dark:text-white shadow-sm focus:border-primary focus:ring-primary sm:text-sm h-12 px-4 transition-colors" 
                                   id="phone"
                                   placeholder="0 (5xx) xxx xx xx" type="tel"
                                   maxlength="15"
                                   value="@telefon"
                                   @oninput="OnPhoneInput" />
                        </div>
                    </div>
                </div>

                <!-- Section: Academic Info -->
                <div class="space-y-6">
                    <div class="flex items-center gap-2 mb-2 pb-2 border-b border-gray-100 dark:border-gray-800">
                        <span class="material-symbols-outlined text-primary">school</span>
                        <h3 class="text-lg font-bold text-text-main dark:text-white">Akademik Bilgiler</h3>
                    </div>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
                        <!-- University Field -->
                        <div class="space-y-1.5">
                            <label class="block text-sm font-medium text-text-main dark:text-gray-300" for="university">
                                Üniversite <span class="text-red-500">*</span>
                            </label>
                            <select class="block w-full rounded-lg border-input-border dark:border-gray-600 bg-background-light dark:bg-gray-800 text-text-main dark:text-white shadow-sm focus:border-primary focus:ring-primary sm:text-sm h-12 px-4 transition-colors" 
                                    id="university"
                                    @bind="universite">
                                <option value="">Üniversite Seçiniz</option>
                                @foreach (var uni in universiteListesi)
                                {
                                    <option value="@uni">@uni</option>
                                }
                            </select>
                        </div>
                        <!-- Department Field -->
                        <div class="space-y-1.5">
                            <label class="block text-sm font-medium text-text-main dark:text-gray-300" for="department">
                                Bölüm <span class="text-red-500">*</span>
                            </label>
                            <select class="block w-full rounded-lg border-input-border dark:border-gray-600 bg-background-light dark:bg-gray-800 text-text-main dark:text-white shadow-sm focus:border-primary focus:ring-primary sm:text-sm h-12 px-4 transition-colors" 
                                    id="department"
                                    @bind="bolum">
                                <option value="">Bölüm Seçiniz</option>
                                @if (bolumler != null && bolumler.Count > 0)
                                {
                                    @foreach (var bolumItem in bolumler)
                                    {
                                        <option value="@bolumItem.BolumAdi">@bolumItem.BolumAdi</option>
                                    }
                                }
                                else
                                {
                                    <option value="" disabled>Bölümler yükleniyor...</option>
                                }
                            </select>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
                        <!-- Sınıf Field -->
                        <div class="space-y-1.5">
                            <label class="block text-sm font-medium text-text-main dark:text-gray-300" for="sinif">
                                Sınıf <span class="text-red-500">*</span>
                            </label>
                            <select class="block w-full rounded-lg border-input-border dark:border-gray-600 bg-background-light dark:bg-gray-800 text-text-main dark:text-white shadow-sm focus:border-primary focus:ring-primary sm:text-sm h-12 px-4 transition-colors" 
                                    id="sinif"
                                    @bind="sinif">
                                <option value="">Sınıf Seçiniz</option>
                                <option value="Hazırlık">Hazırlık</option>
                                <option value="1. Sınıf">1. Sınıf</option>
                                <option value="2. Sınıf">2. Sınıf</option>
                                <option value="3. Sınıf">3. Sınıf</option>
                                <option value="4. Sınıf">4. Sınıf</option>
                            </select>
                        </div>
                        <!-- AGNO Field -->
                        <div class="space-y-1.5">
                            <label class="block text-sm font-medium text-text-main dark:text-gray-300" for="agno">
                                AGNO (0-4) <span class="text-red-500">*</span>
                            </label>
                            <input class="block w-full rounded-lg border-input-border dark:border-gray-600 bg-background-light dark:bg-gray-800 text-text-main dark:text-white shadow-sm focus:border-primary focus:ring-primary sm:text-sm h-12 px-4 transition-colors" 
                                   id="agno" 
                                   placeholder="Örn: 3.25" 
                                   type="number"
                                   step="0.01"
                                   min="0"
                                   max="4"
                                   @bind="agno" />
                        </div>
                    </div>
                </div>

                <!-- Section: Financial Info -->
                <div class="space-y-6">
                    <div class="flex items-center gap-2 mb-2 pb-2 border-b border-gray-100 dark:border-gray-800">
                        <span class="material-symbols-outlined text-primary">account_balance_wallet</span>
                        <h3 class="text-lg font-bold text-text-main dark:text-white">Mali Bilgiler</h3>
                    </div>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
                        <!-- Kardeş Sayısı Field -->
                        <div class="space-y-1.5">
                            <label class="block text-sm font-medium text-text-main dark:text-gray-300" for="kardesSayisi">
                                Kardeş Sayısı <span class="text-red-500">*</span>
                            </label>
                            <input class="block w-full rounded-lg border-input-border dark:border-gray-600 bg-background-light dark:bg-gray-800 text-text-main dark:text-white shadow-sm focus:border-primary focus:ring-primary sm:text-sm h-12 px-4 transition-colors" 
                                   id="kardesSayisi" 
                                   placeholder="0" 
                                   type="number"
                                   min="0"
                                   @bind="kardesSayisi" />
                        </div>
                        <!-- Hane Geliri Field -->
                        <div class="space-y-1.5">
                            <label class="block text-sm font-medium text-text-main dark:text-gray-300" for="haneGeliri">
                                Toplam Hane Geliri (₺) <span class="text-red-500">*</span>
                            </label>
                            <input class="block w-full rounded-lg border-input-border dark:border-gray-600 bg-background-light dark:bg-gray-800 text-text-main dark:text-white shadow-sm focus:border-primary focus:ring-primary sm:text-sm h-12 px-4 transition-colors" 
                                   id="haneGeliri" 
                                   placeholder="Aylık toplam gelir" 
                                   type="number"
                                   min="0"
                                   @bind="haneGeliri" />
                        </div>
                    </div>
                </div>

                <!-- Section: Questions -->
                <div class="space-y-6">
                    <div class="flex items-center gap-2 mb-2 pb-2 border-b border-gray-100 dark:border-gray-800">
                        <span class="material-symbols-outlined text-primary">quiz</span>
                        <h3 class="text-lg font-bold text-text-main dark:text-white">Başvuru Soruları</h3>
                    </div>
                    
                    <!-- Soru 1: İhtiyaç -->
                    <div class="space-y-2">
                        <label class="block text-sm font-medium text-text-main dark:text-gray-300" for="ihtiyac">
                            1. Neden bursa ihtiyacınız var? <span class="text-red-500">*</span>
                        </label>
                        <p class="text-xs text-text-secondary dark:text-gray-500 mb-2">
                            Bursa neden ihtiyacınız olduğunu açıklayınız.
                        </p>
                        <textarea class="block w-full rounded-lg border-input-border dark:border-gray-600 bg-background-light dark:bg-gray-800 text-text-main dark:text-white shadow-sm focus:border-primary focus:ring-primary sm:text-sm p-4 resize-none transition-colors" 
                                  id="ihtiyac" 
                                  placeholder="Cevabınızı buraya yazın..." 
                                  rows="4"
                                  @bind="ihtiyac"></textarea>
                    </div>

                    <!-- Soru 2: Hedefler -->
                    <div class="space-y-2">
                        <label class="block text-sm font-medium text-text-main dark:text-gray-300" for="hedefler">
                            2. Kariyer hedefleriniz nelerdir? <span class="text-red-500">*</span>
                        </label>
                        <p class="text-xs text-text-secondary dark:text-gray-500 mb-2">
                            Gelecekteki kariyer planlarınızı ve hedeflerinizi paylaşınız.
                        </p>
                        <textarea class="block w-full rounded-lg border-input-border dark:border-gray-600 bg-background-light dark:bg-gray-800 text-text-main dark:text-white shadow-sm focus:border-primary focus:ring-primary sm:text-sm p-4 resize-none transition-colors" 
                                  id="hedefler" 
                                  placeholder="Cevabınızı buraya yazın..." 
                                  rows="4"
                                  @bind="hedefler"></textarea>
                    </div>

                    <!-- Soru 3: Kullanım -->
                    <div class="space-y-2">
                        <label class="block text-sm font-medium text-text-main dark:text-gray-300" for="kullanim">
                            3. Bursu nasıl kullanacaksınız? <span class="text-red-500">*</span>
                        </label>
                        <p class="text-xs text-text-secondary dark:text-gray-500 mb-2">
                            Bursu hangi amaçlarla kullanmayı planladığınızı belirtiniz.
                        </p>
                        <textarea class="block w-full rounded-lg border-input-border dark:border-gray-600 bg-background-light dark:bg-gray-800 text-text-main dark:text-white shadow-sm focus:border-primary focus:ring-primary sm:text-sm p-4 resize-none transition-colors" 
                                  id="kullanim" 
                                  placeholder="Cevabınızı buraya yazın..." 
                                  rows="4"
                                  @bind="kullanim"></textarea>
                    </div>

                    <!-- Soru 4: Farklı Özellik -->
                    <div class="space-y-2">
                        <label class="block text-sm font-medium text-text-main dark:text-gray-300" for="farkliOzellik">
                            4. Sizi diğer adaylardan ayıran nedir? <span class="text-red-500">*</span>
                        </label>
                        <p class="text-xs text-text-secondary dark:text-gray-500 mb-2">
                            Kendinizi diğer adaylardan ayıran özelliklerinizi, başarılarınızı veya deneyimlerinizi paylaşınız.
                        </p>
                        <textarea class="block w-full rounded-lg border-input-border dark:border-gray-600 bg-background-light dark:bg-gray-800 text-text-main dark:text-white shadow-sm focus:border-primary focus:ring-primary sm:text-sm p-4 resize-none transition-colors" 
                                  id="farkliOzellik" 
                                  placeholder="Cevabınızı buraya yazın..." 
                                  rows="4"
                                  @bind="farkliOzellik"></textarea>
                    </div>
                </div>

                <!-- Submission & Legal -->
                <div class="pt-4 border-t border-gray-100 dark:border-gray-800">
                    <div class="flex items-start gap-3 mb-6">
                        <div class="flex h-6 items-center">
                            <input class="h-5 w-5 rounded border-gray-300 text-primary focus:ring-primary transition-colors" 
                                   id="consent" 
                                   name="consent" 
                                   type="checkbox"
                                   @bind="kvkkOnay" />
                        </div>
                        <div class="text-sm leading-6">
                            <label class="font-medium text-text-main dark:text-gray-300" for="consent">KVKK Aydınlatma Metni'ni okudum ve onaylıyorum.</label>
                            <p class="text-text-secondary dark:text-gray-500 text-xs mt-1">Paylaştığınız bilgiler sadece burs değerlendirme süreci için kullanılacaktır.</p>
                        </div>
                    </div>
                    <button type="submit" class="group relative w-full flex justify-center py-4 px-4 border border-transparent text-sm font-bold rounded-xl text-white bg-primary hover:bg-primary-dark focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary transition-all duration-200 shadow-lg shadow-primary/30 hover:shadow-primary/50">
                        <span class="absolute left-0 inset-y-0 flex items-center pl-3">
                            <span class="material-symbols-outlined group-hover:translate-x-1 transition-transform">send</span>
                        </span>
                        Başvuruyu Tamamla
                    </button>
                </div>
            </form>
        </div>

        <!-- Footer Text -->
        <div class="mt-8 text-center">
            <p class="text-sm text-text-secondary dark:text-gray-500">
                © 2024 Burs Vakfı. Tüm hakları saklıdır.
            </p>
        </div>
    </div>
</main>

@code {
    // Form alanları - Veritabanı kolonlarına göre
    private string ad = "";
    private string soyad = "";
    private string eposta = "";
    private string telefon = "";
    private string universite = "";
    private string bolum = "";
    private string sinif = "";
    private int kardesSayisi = 0;
    private decimal haneGeliri = 0;
    private double agno = 0;
    private string ihtiyac = "";
    private string hedefler = "";
    private string kullanim = "";
    private string farkliOzellik = "";
    private bool kvkkOnay = false;
    private string mesaj = "";

    // Bölümler için
    private List<BolumItem> bolumler = new List<BolumItem>();

    // Üniversite listesi
    private List<string> universiteListesi = new List<string>();

    // Bağlantı string'i
    string connectionString = @"Data Source=(localdb)\MSSQLLocalDB; initial catalog=bursOtoDeneme1; Integrated Security=TRUE; Encrypt=False; TrustServerCertificate=True;";

    private bool IsErrorMessage =>
        !string.IsNullOrEmpty(mesaj) && mesaj.StartsWith("Hata");

    // Bölüm sınıfı
    public class BolumItem
    {
        public int ID { get; set; }
        public string BolumAdi { get; set; } = "";
    }

    protected override async Task OnInitializedAsync()
    {
        try
        {
            await LoadUniversiteListesi();
            await LoadBolumler();
        }
        catch (Exception ex)
        {
            // Hata durumunda mesaj göster ama uygulamayı çökertme
            System.Diagnostics.Debug.WriteLine($"OnInitializedAsync hatası: {ex.Message}");
        }
    }

    private async Task LoadUniversiteListesi()
    {
        universiteListesi = new List<string>
        {
            "Adana Alparslan Türkeş Bilim ve Teknoloji Üniversitesi",
            "Çukurova Üniversitesi",
            "Adıyaman Üniversitesi",
            "Afyon Kocatepe Üniversitesi",
            "Afyonkarahisar Sağlık Bilimleri Üniversitesi",
            "Ağrı İbrahim Çeçen Üniversitesi",
            "Aksaray Üniversitesi",
            "Amasya Üniversitesi",
            "Jandarma ve Sahil Güvenlik Akademisi",
            "Ankara Üniversitesi",
            "Ankara Müzik ve Güzel Sanatlar Üniversitesi",
            "Ankara Hacı Bayram Veli Üniversitesi",
            "Ankara Sosyal Bilimler Üniversitesi",
            "Gazi Üniversitesi",
            "Hacettepe Üniversitesi",
            "Orta Doğu Teknik Üniversitesi",
            "Ankara Yıldırım Beyazıt Üniversitesi",
            "Polis Akademisi",
            "Ankara Bilim Üniversitesi",
            "Ankara Medipol Üniversitesi",
            "Atılım Üniversitesi",
            "Başkent Üniversitesi",
            "Çankaya Üniversitesi",
            "İhsan Doğramacı Bilkent Üniversitesi",
            "Lokman Hekim Üniversitesi",
            "Ostim Teknik Üniversitesi",
            "TED Üniversitesi",
            "TOBB Ekonomi ve Teknoloji Üniversitesi",
            "Ufuk Üniversitesi",
            "Türk Hava Kurumu Üniversitesi",
            "Yüksek İhtisas Üniversitesi",
            "Akdeniz Üniversitesi",
            "Alanya Alaaddin Keykubat Üniversitesi",
            "Alanya Üniversitesi",
            "Antalya Belek Üniversitesi",
            "Antalya Bilim Üniversitesi",
            "Ardahan Üniversitesi",
            "Artvin Çoruh Üniversitesi",
            "Aydın Adnan Menderes Üniversitesi",
            "Balıkesir Üniversitesi",
            "Bandırma Onyedi Eylül Üniversitesi",
            "Bartın Üniversitesi",
            "Batman Üniversitesi",
            "Bayburt Üniversitesi",
            "Bilecik Şeyh Edebali Üniversitesi",
            "Bingöl Üniversitesi",
            "Bitlis Eren Üniversitesi",
            "Bolu Abant İzzet Baysal Üniversitesi",
            "Burdur Mehmet Akif Ersoy Üniversitesi",
            "Bursa Teknik Üniversitesi",
            "Bursa Uludağ Üniversitesi",
            "Mudanya Üniversitesi",
            "Çanakkale Onsekiz Mart Üniversitesi",
            "Çankırı Karatekin Üniversitesi",
            "Hitit Üniversitesi",
            "Pamukkale Üniversitesi",
            "Dicle Üniversitesi",
            "Düzce Üniversitesi",
            "Trakya Üniversitesi",
            "Fırat Üniversitesi",
            "Erzincan Binali Yıldırım Üniversitesi",
            "Atatürk Üniversitesi",
            "Erzurum Teknik Üniversitesi",
            "Anadolu Üniversitesi",
            "Eskişehir Osmangazi Üniversitesi",
            "Eskişehir Teknik Üniversitesi",
            "Gaziantep Üniversitesi",
            "Gaziantep İslam Bilim ve Teknoloji Üniversitesi",
            "Hasan Kalyoncu Üniversitesi",
            "Sanko Üniversitesi",
            "Giresun Üniversitesi",
            "Gümüşhane Üniversitesi",
            "Hakkari Üniversitesi",
            "İskenderun Teknik Üniversitesi",
            "Hatay Mustafa Kemal Üniversitesi",
            "Iğdır Üniversitesi",
            "Süleyman Demirel Üniversitesi",
            "Isparta Uygulamalı Bilimler Üniversitesi",
            "Boğaziçi Üniversitesi",
            "Galatasaray Üniversitesi",
            "İstanbul Medeniyet Üniversitesi",
            "İstanbul Teknik Üniversitesi",
            "İstanbul Üniversitesi",
            "İstanbul Üniversitesi-Cerrahpaşa",
            "Marmara Üniversitesi",
            "Milli Savunma Üniversitesi",
            "Mimar Sinan Güzel Sanatlar Üniversitesi",
            "Türk-Alman Üniversitesi",
            "Türk-Japon Bilim ve Teknoloji Üniversitesi",
            "Sağlık Bilimleri Üniversitesi",
            "Yıldız Teknik Üniversitesi",
            "Acıbadem Üniversitesi",
            "Altınbaş Üniversitesi",
            "Bahçeşehir Üniversitesi",
            "Beykoz Üniversitesi",
            "Bezmialem Vakıf Üniversitesi",
            "Biruni Üniversitesi",
            "Demiroğlu Bilim Üniversitesi",
            "Doğuş Üniversitesi",
            "Fatih Sultan Mehmet Üniversitesi",
            "Fenerbahçe Üniversitesi",
            "Haliç Üniversitesi",
            "Işık Üniversitesi",
            "İbn Haldun Üniversitesi",
            "İstanbul 29 Mayıs Üniversitesi",
            "İstanbul Arel Üniversitesi",
            "İstanbul Atlas Üniversitesi",
            "İstanbul Aydın Üniversitesi",
            "İstanbul Beykent Üniversitesi",
            "İstanbul Bilgi Üniversitesi",
            "İstanbul Esenyurt Üniversitesi",
            "İstanbul Galata Üniversitesi",
            "İstanbul Gedik Üniversitesi",
            "İstanbul Gelişim Üniversitesi",
            "İstanbul Kent Üniversitesi",
            "İstanbul Kültür Üniversitesi",
            "İstanbul Medipol Üniversitesi",
            "İstanbul Nişantaşı Üniversitesi",
            "İstanbul Okan Üniversitesi",
            "İstanbul Rumeli Üniversitesi",
            "İstanbul Sabahattin Zaim Üniversitesi",
            "İstanbul Sağlık ve Teknoloji Üniversitesi",
            "İstanbul Ticaret Üniversitesi",
            "İstanbul Topkapı Üniversitesi",
            "İstanbul Yeni Yüzyıl Üniversitesi",
            "İstinye Üniversitesi",
            "Kadir Has Üniversitesi",
            "Koç Üniversitesi",
            "Maltepe Üniversitesi",
            "MEF Üniversitesi",
            "Özyeğin Üniversitesi",
            "Piri Reis Üniversitesi",
            "Sabancı Üniversitesi",
            "Üsküdar Üniversitesi",
            "Yeditepe Üniversitesi",
            "Dokuz Eylül Üniversitesi",
            "Ege Üniversitesi",
            "İzmir Yüksek Teknoloji Enstitüsü",
            "İzmir Kâtip Çelebi Üniversitesi",
            "İzmir Bakırçay Üniversitesi",
            "İzmir Demokrasi Üniversitesi",
            "İzmir Ekonomi Üniversitesi",
            "İzmir Tınaztepe Üniversitesi",
            "Yaşar Üniversitesi",
            "Kahramanmaraş Sütçü İmam Üniversitesi",
            "Kahramanmaraş İstiklal Üniversitesi",
            "Karabük Üniversitesi",
            "Karamanoğlu Mehmetbey Üniversitesi",
            "Kafkas Üniversitesi",
            "Kastamonu Üniversitesi",
            "Abdullah Gül Üniversitesi",
            "Erciyes Üniversitesi",
            "Kayseri Üniversitesi",
            "Nuh Naci Yazgan Üniversitesi",
            "Kırıkkale Üniversitesi",
            "Kırklareli Üniversitesi",
            "Kırşehir Ahi Evran Üniversitesi",
            "Kilis 7 Aralık Üniversitesi",
            "Gebze Teknik Üniversitesi",
            "Kocaeli Üniversitesi",
            "Kocaeli Sağlık ve Teknoloji Üniversitesi",
            "Konya Teknik Üniversitesi",
            "Necmettin Erbakan Üniversitesi",
            "Selçuk Üniversitesi",
            "Konya Gıda ve Tarım Üniversitesi",
            "KTO Karatay Üniversitesi",
            "Kütahya Dumlupınar Üniversitesi",
            "Kütahya Sağlık Bilimleri Üniversitesi",
            "İnönü Üniversitesi",
            "Malatya Turgut Özal Üniversitesi",
            "Manisa Celal Bayar Üniversitesi",
            "Mardin Artuklu Üniversitesi",
            "Mersin Üniversitesi",
            "Tarsus Üniversitesi",
            "Çağ Üniversitesi",
            "Toros Üniversitesi",
            "Muğla Sıtkı Koçman Üniversitesi",
            "Muş Alparslan Üniversitesi",
            "Nevşehir Hacı Bektaş Veli Üniversitesi",
            "Kapadokya Üniversitesi",
            "Niğde Ömer Halisdemir Üniversitesi",
            "Ordu Üniversitesi",
            "Osmaniye Korkut Ata Üniversitesi",
            "Recep Tayyip Erdoğan Üniversitesi",
            "Sakarya Üniversitesi",
            "Sakarya Uygulamalı Bilimler Üniversitesi",
            "Ondokuz Mayıs Üniversitesi",
            "Samsun Üniversitesi",
            "Siirt Üniversitesi",
            "Sinop Üniversitesi",
            "Sivas Cumhuriyet Üniversitesi",
            "Sivas Bilim ve Teknoloji Üniversitesi",
            "Harran Üniversitesi",
            "Şırnak Üniversitesi",
            "Tekirdağ Namık Kemal Üniversitesi",
            "Tokat Gaziosmanpaşa Üniversitesi",
            "Karadeniz Teknik Üniversitesi",
            "Trabzon Üniversitesi",
            "Avrasya Üniversitesi",
            "Munzur Üniversitesi",
            "Uşak Üniversitesi",
            "Van Yüzüncü Yıl Üniversitesi",
            "Yalova Üniversitesi",
            "Yozgat Bozok Üniversitesi",
            "Zonguldak Bülent Ecevit Üniversitesi",
            "İstanbul Sağlık ve Sosyal Bilimler Meslek Yüksekokulu",
            "Ataşehir Adıgüzel Meslek Yüksekokulu",
            "İstanbul Şişli Meslek Yüksekokulu",
            "İzmir Kavram Meslek Yüksekokulu"
        };
        
        universiteListesi = universiteListesi.OrderBy(u => u).ToList();
        await Task.CompletedTask;
    }

    private async Task LoadBolumler()
    {
        try
        {
            using (SqlConnection conn = new SqlConnection(connectionString))
            {
                await conn.OpenAsync();
                string query = "SELECT TOP (1000) [ID], [BolumAdi] FROM [Bolumler] ORDER BY [BolumAdi]";
                
                using (SqlCommand cmd = new SqlCommand(query, conn))
                {
                    using (var reader = await cmd.ExecuteReaderAsync())
                    {
                        var tempList = new List<BolumItem>();
                        while (await reader.ReadAsync())
                        {
                            if (!reader.IsDBNull(0) && !reader.IsDBNull(1))
                            {
                                tempList.Add(new BolumItem
                                {
                                    ID = reader.GetInt32(0),
                                    BolumAdi = reader.GetString(1)
                                });
                            }
                        }
                        bolumler = tempList;
                    }
                }
            }
        }
        catch (Exception ex)
        {
            // Hata durumunda boş liste kullan, uygulamayı çökertme
            bolumler = new List<BolumItem>();
            System.Diagnostics.Debug.WriteLine($"LoadBolumler hatası: {ex.Message}");
            // Mesaj gösterme, sadece debug'a yaz
        }
    }


    private async Task OnPhoneInput(ChangeEventArgs e)
    {
        try
        {
            if (e.Value != null)
            {
                string value = e.Value.ToString() ?? "";

                // 1. Sadece rakamları ayıkla
                string digitsOnly = new string(value.Where(char.IsDigit).ToArray());

                // 2. Eğer kullanıcı 0 ile başlamadıysa başına 0 ekle (opsiyonel ama güvenli)
                if (digitsOnly.Length > 0 && digitsOnly[0] != '0')
                {
                    digitsOnly = "0" + digitsOnly;
                }

                // 3. KESİN SINIR: Maksimum 11 rakam (0 + 10 hane)
                if (digitsOnly.Length > 11)
                {
                    digitsOnly = digitsOnly.Substring(0, 11);
                }

                int l = digitsOnly.Length;

                // 4. FORMATLAMA (string telefon = demiyoruz, direkt sınıf değişkenini güncelliyoruz)
                telefon = l switch
                {
                    0 => "",
                    <= 1 => digitsOnly, // "0"
                    <= 4 => $"0({digitsOnly.Substring(1)}", // "0(546"
                    <= 7 => $"0({digitsOnly.Substring(1, 3)}){digitsOnly.Substring(4)}", // "0(546)235"
                    <= 9 => $"0({digitsOnly.Substring(1, 3)}){digitsOnly.Substring(4, 3)} {digitsOnly.Substring(7)}", // "0(546)235 44"
                    _ => $"0({digitsOnly.Substring(1, 3)}){digitsOnly.Substring(4, 3)} {digitsOnly.Substring(7, 2)} {digitsOnly.Substring(9)}" // "0(546)235 44 55"
                };

                await InvokeAsync(StateHasChanged);
            }
        }
        catch (Exception ex)
        {
            System.Diagnostics.Debug.WriteLine($"OnPhoneInput hatası: {ex.Message}");
        }
    }

    private void NavigateHome()
    {
        NavManager.NavigateTo("/");
    }

    private async Task HandleSubmit()
    {
        // Validasyon - Tüm zorunlu alanlar
        if (string.IsNullOrWhiteSpace(ad))
        {
            mesaj = "Hata: Lütfen Ad bilgisini giriniz.";
            StateHasChanged();
            return;
        }

        if (string.IsNullOrWhiteSpace(soyad))
        {
            mesaj = "Hata: Lütfen Soyad bilgisini giriniz.";
            StateHasChanged();
            return;
        }

        if (string.IsNullOrWhiteSpace(eposta))
        {
            mesaj = "Hata: Lütfen E-posta Adresi bilgisini giriniz.";
            StateHasChanged();
            return;
        }

        if (string.IsNullOrWhiteSpace(telefon))
        {
            mesaj = "Hata: Lütfen Telefon Numarası bilgisini giriniz.";
            StateHasChanged();
            return;
        }

        if (string.IsNullOrWhiteSpace(universite))
        {
            mesaj = "Hata: Lütfen Üniversite bilgisini seçiniz.";
            StateHasChanged();
            return;
        }

        if (string.IsNullOrWhiteSpace(bolum))
        {
            mesaj = "Hata: Lütfen Bölüm bilgisini seçiniz.";
            StateHasChanged();
            return;
        }

        if (string.IsNullOrWhiteSpace(sinif))
        {
            mesaj = "Hata: Lütfen Sınıf bilgisini seçiniz.";
            StateHasChanged();
            return;
        }

        if (agno < 0 || agno > 4)
        {
            mesaj = "Hata: AGNO 0 ile 4 arasında olmalıdır.";
            StateHasChanged();
            return;
        }

        if (haneGeliri <= 0)
        {
            mesaj = "Hata: Lütfen geçerli bir Hane Geliri giriniz.";
            StateHasChanged();
            return;
        }

        if (string.IsNullOrWhiteSpace(ihtiyac))
        {
            mesaj = "Hata: Lütfen 'Neden bursa ihtiyacınız var?' sorusunu cevaplayınız.";
            StateHasChanged();
            return;
        }

        if (string.IsNullOrWhiteSpace(hedefler))
        {
            mesaj = "Hata: Lütfen 'Kariyer hedefleriniz nelerdir?' sorusunu cevaplayınız.";
            StateHasChanged();
            return;
        }

        if (string.IsNullOrWhiteSpace(kullanim))
        {
            mesaj = "Hata: Lütfen 'Bursu nasıl kullanacaksınız?' sorusunu cevaplayınız.";
            StateHasChanged();
            return;
        }

        if (string.IsNullOrWhiteSpace(farkliOzellik))
        {
            mesaj = "Hata: Lütfen 'Sizi diğer adaylardan ayıran nedir?' sorusunu cevaplayınız.";
            StateHasChanged();
            return;
        }

        if (!kvkkOnay)
        {
            mesaj = "Hata: Lütfen KVKK Aydınlatma Metni'ni onaylayınız.";
            StateHasChanged();
            return;
        }

        try
        {
            using (SqlConnection conn = new SqlConnection(connectionString))
            {
                conn.Open();

                // Kolonların varlığını kontrol et
                var mevcutKolonlar = new HashSet<string>();
                try
                {
                    using (SqlCommand checkCmd = new SqlCommand(
                        "SELECT COLUMN_NAME FROM INFORMATION_SCHEMA.COLUMNS WHERE TABLE_NAME = 'Ogrenciler' AND COLUMN_NAME IN ('Email', 'Mail', 'Eposta', 'Üniversite', 'Universite', 'Ihtiyac', 'Hedefler', 'BursKullanim', 'FarkliOzellik', 'Motivasyon')", conn))
                    {
                        using (var reader = checkCmd.ExecuteReader())
                        {
                            while (reader.Read())
                            {
                                mevcutKolonlar.Add(reader[0].ToString());
                            }
                        }
                    }
                }
                catch { }

                // INSERT sorgusu için kolonları dinamik oluştur
                var kolonlar = new List<string> { "AD", "SOYAD", "[KARDEŞ SAYISI]", "[TOPLAM HANE GELİRİ]", "BÖLÜMÜ", "SINIF", "AGNO", "TELEFON" };
                var degerler = new List<string> { "@p1", "@p2", "@p3", "@p4", "@p5", "@p6", "@p7", "@p8" };
                int paramIndex = 9;

                // Email kolonu
                string emailKolon = mevcutKolonlar.Contains("Email") ? "Email" : (mevcutKolonlar.Contains("Mail") ? "Mail" : (mevcutKolonlar.Contains("Eposta") ? "Eposta" : null));
                if (emailKolon != null)
                {
                    kolonlar.Add(emailKolon);
                    degerler.Add($"@p{paramIndex++}");
                }

                // Üniversite kolonu
                string universiteKolon = mevcutKolonlar.Contains("UNIVERSITE") ? "UNIVERSITE" : (mevcutKolonlar.Contains("UNIVERSITE") ? "UNIVERSITE" : null);
                if (universiteKolon != null)
                {
                    kolonlar.Add(universiteKolon);
                    degerler.Add($"@p{paramIndex++}");
                }

                // Soru kolonları
                if (mevcutKolonlar.Contains("Ihtiyac"))
                {
                    kolonlar.Add("Ihtiyac");
                    degerler.Add($"@p{paramIndex++}");
                }
                if (mevcutKolonlar.Contains("Hedefler"))
                {
                    kolonlar.Add("Hedefler");
                    degerler.Add($"@p{paramIndex++}");
                }
                if (mevcutKolonlar.Contains("BursKullanim"))
                {
                    kolonlar.Add("BursKullanim");
                    degerler.Add($"@p{paramIndex++}");
                }
                if (mevcutKolonlar.Contains("FarkliOzellik"))
                {
                    kolonlar.Add("FarkliOzellik");
                    degerler.Add($"@p{paramIndex++}");
                }

                // AINotu veya Motivasyon (fallback)
                if (mevcutKolonlar.Contains("Motivasyon"))
                {
                    kolonlar.Add("Motivasyon");
                    degerler.Add($"@p{paramIndex++}");
                }
                else
                {
                    kolonlar.Add("AINotu");
                    degerler.Add($"@p{paramIndex++}");
                }

                string query = $"INSERT INTO Ogrenciler ({string.Join(", ", kolonlar)}) VALUES ({string.Join(", ", degerler)}); SELECT SCOPE_IDENTITY();";

                int yeniOgrenciID;
                using (SqlCommand cmd = new SqlCommand(query, conn))
                {
                    int pIdx = 1;
                    cmd.Parameters.AddWithValue($"@p{pIdx++}", ad.Trim().ToUpper());
                    cmd.Parameters.AddWithValue($"@p{pIdx++}", soyad.Trim().ToUpper());
                    cmd.Parameters.AddWithValue($"@p{pIdx++}", kardesSayisi);
                    cmd.Parameters.AddWithValue($"@p{pIdx++}", haneGeliri);
                    cmd.Parameters.AddWithValue($"@p{pIdx++}", bolum.Trim());
                    cmd.Parameters.AddWithValue($"@p{pIdx++}", sinif);
                    cmd.Parameters.AddWithValue($"@p{pIdx++}", agno);
                    cmd.Parameters.AddWithValue($"@p{pIdx++}", telefon.Trim());

                    // Email
                    if (emailKolon != null)
                    {
                        cmd.Parameters.AddWithValue($"@p{pIdx++}", eposta.Trim());
                    }

                    // Üniversite
                    if (universiteKolon != null)
                    {
                        cmd.Parameters.AddWithValue($"@p{pIdx++}", universite.Trim());
                    }

                    // Sorular
                    if (mevcutKolonlar.Contains("Ihtiyac"))
                    {
                        cmd.Parameters.AddWithValue($"@p{pIdx++}", ihtiyac.Trim());
                    }
                    if (mevcutKolonlar.Contains("Hedefler"))
                    {
                        cmd.Parameters.AddWithValue($"@p{pIdx++}", hedefler.Trim());
                    }
                    if (mevcutKolonlar.Contains("BursKullanim"))
                    {
                        cmd.Parameters.AddWithValue($"@p{pIdx++}", kullanim.Trim());
                    }
                    if (mevcutKolonlar.Contains("FarkliOzellik"))
                    {
                        cmd.Parameters.AddWithValue($"@p{pIdx++}", farkliOzellik.Trim());
                    }

                    // AINotu veya Motivasyon
                    if (mevcutKolonlar.Contains("Motivasyon"))
                    {
                        // Motivasyon kolonu varsa, soruları birleştir
                        string motivasyonMetni = $"[İHTİYAÇ] {ihtiyac}\n\n[HEDEFLER] {hedefler}\n\n[KULLANIM] {kullanim}";
                        cmd.Parameters.AddWithValue($"@p{pIdx++}", motivasyonMetni.Trim());
                    }
                    else
                    {
                        // AINotu'na tüm bilgileri ekle
                        string ainoNotu = $"[UNIVERSITE]: {universite}\n[E-POSTA]: {eposta}\n[İHTİYAÇ]: {ihtiyac}\n[HEDEFLER]: {hedefler}\n[KULLANIM]: {kullanim}\n[FARK]: {farkliOzellik}";
                        cmd.Parameters.AddWithValue($"@p{pIdx++}", ainoNotu.Trim());
                    }

                    yeniOgrenciID = Convert.ToInt32(cmd.ExecuteScalar());
                }

                // OgrenciBurslari tablosuna beklemede kaydı ekle
                try
                {
                    // Burslar tablosundaki ID kolonunu dinamik tespit et
                    string bursIDKolonu = "BursID";
                    try
                    {
                        SqlCommand cmdKolon = new SqlCommand(@"SELECT TOP 1 COLUMN_NAME 
                            FROM INFORMATION_SCHEMA.COLUMNS 
                            WHERE TABLE_NAME = 'Burslar' 
                            AND COLUMN_NAME IN ('BursID', 'ID')
                            ORDER BY CASE COLUMN_NAME 
                                WHEN 'BursID' THEN 1 
                                WHEN 'ID' THEN 2 
                                ELSE 3 END", conn);
                        var kolonResult = cmdKolon.ExecuteScalar();
                        if (kolonResult != null && kolonResult != DBNull.Value)
                            bursIDKolonu = kolonResult.ToString();
                    }
                    catch { }

                    // Mevcut bir burs ID'si bul (herhangi bir burs)
                    int mevcutBursID = 0;
                    try
                    {
                        SqlCommand cmdBurs = new SqlCommand($"SELECT TOP 1 [{bursIDKolonu}] FROM Burslar", conn);
                        var bursResult = cmdBurs.ExecuteScalar();
                        if (bursResult != null && bursResult != DBNull.Value)
                            mevcutBursID = Convert.ToInt32(bursResult);
                    }
                    catch { }

                    if (mevcutBursID > 0)
                    {
                        string bursQuery = @"INSERT INTO OgrenciBurslari (OgrenciID, BursID, BaslangicTarihi, Durum) 
                                             VALUES (@ogrID, @bursID, @tarih, 0)";
                        using (SqlCommand bursCmd = new SqlCommand(bursQuery, conn))
                        {
                            bursCmd.Parameters.AddWithValue("@ogrID", yeniOgrenciID);
                            bursCmd.Parameters.AddWithValue("@bursID", mevcutBursID);
                            bursCmd.Parameters.AddWithValue("@tarih", DateTime.Now);
                            bursCmd.ExecuteNonQuery();
                        }
                    }
                    else
                    {
                        // Burs yoksa BursID olmadan ekle (eğer tablo izin veriyorsa)
                        try
                        {
                            string bursQuery = @"INSERT INTO OgrenciBurslari (OgrenciID, BaslangicTarihi, Durum) 
                                                 VALUES (@ogrID, @tarih, 0)";
                            using (SqlCommand bursCmd = new SqlCommand(bursQuery, conn))
                            {
                                bursCmd.Parameters.AddWithValue("@ogrID", yeniOgrenciID);
                                bursCmd.Parameters.AddWithValue("@tarih", DateTime.Now);
                                bursCmd.ExecuteNonQuery();
                            }
                        }
                        catch { } // BursID zorunluysa sessizce devam et
                    }
                }
                catch { } // Burs kaydı opsiyonel

                mesaj = "Başvurunuz başarıyla kaydedildi! Komisyon değerlendirmesi sonrasında tarafınıza bilgi verilecektir.";

                // Formu temizle
                ad = "";
                soyad = "";
                eposta = "";
                telefon = "";
                universite = "";
                bolum = "";
                sinif = "";
                kardesSayisi = 0;
                haneGeliri = 0;
                agno = 0;
                ihtiyac = "";
                hedefler = "";
                kullanim = "";
                farkliOzellik = "";
                kvkkOnay = false;
            }
        }
        catch (Exception ex)
        {
            // Detaylı hata mesajı için log
            System.Diagnostics.Debug.WriteLine($"Başvuru kaydetme hatası: {ex.Message}");
            System.Diagnostics.Debug.WriteLine($"Stack Trace: {ex.StackTrace}");
            
            // Kullanıcıya daha anlaşılır hata mesajı göster
            if (ex.Message.Contains("Invalid column name") || ex.Message.Contains("Geçersiz sütun adı"))
            {
                mesaj = "Hata: Veritabanı şeması ile uyumsuzluk tespit edildi. Lütfen sistem yöneticisine başvurun.";
            }
            else if (ex.Message.Contains("Cannot insert") || ex.Message.Contains("Ekleme yapılamıyor"))
            {
                mesaj = "Hata: Veri kaydedilemedi. Lütfen tüm alanların doğru doldurulduğundan emin olun.";
            }
            else if (ex.Message.Contains("connection") || ex.Message.Contains("bağlantı"))
            {
                mesaj = "Hata: Veritabanı bağlantısı kurulamadı. Lütfen daha sonra tekrar deneyin.";
            }
            else
            {
                mesaj = $"Hata: {ex.Message}";
            }
        }

        StateHasChanged();
    }
}
