@page "/burs-ver"
@using Microsoft.Data.SqlClient
@inject NavigationManager NavManager
@rendermode InteractiveServer

<PageTitle>Eğitim Gönüllüsü Ol - Burs Ver</PageTitle>

<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="card shadow-lg border-0 rounded-4">

                <div class="card-header bg-primary bg-gradient text-white text-center py-4 rounded-top-4">
                    <h3 class="fw-bold mb-0"><i class="bi bi-heart-fill me-2"></i>Eğitim Gönüllüsü Ol</h3>
                    <p class="mb-0 mt-2 opacity-75">Geleceğin mimarlarına bir tuğla da siz koyun.</p>
                </div>

                <div class="card-body p-5">

                    @if (!string.IsNullOrEmpty(mesaj))
                    {
                        var alertClass = IsErrorMessage ? "alert-danger" : "alert-success";
                        <div class="alert @alertClass d-flex align-items-center mb-4 shadow-sm" role="alert">
                            @if (IsErrorMessage)
                            {
                                <i class="bi bi-exclamation-triangle-fill me-2"></i>
                            }
                            else
                            {
                                <i class="bi bi-check-circle-fill me-2"></i>
                            }
                            <div>@mesaj</div>
                        </div>
                    }

                    <div class="row g-4">
                        <div class="col-md-6">
                            <label class="form-label fw-bold text-secondary">Ad Soyad</label>
                            <input type="text" @bind="adSoyad" class="form-control form-control-lg bg-light" placeholder="Adınız Soyadınız">
                        </div>

                        <div class="col-md-6">
                            <label class="form-label fw-bold text-secondary">Telefon</label>
                            <input type="tel" @bind="telefon" class="form-control form-control-lg bg-light" placeholder="05XX XXX XX XX">
                        </div>

                        <div class="col-md-6">
                            <label class="form-label fw-bold text-secondary">E-Posta</label>
                            <input type="email" @bind="eposta" class="form-control form-control-lg bg-light" placeholder="mail@ornek.com">
                        </div>

                        <div class="col-md-6">
                            <label class="form-label fw-bold text-secondary">Kurum / Şirket (Opsiyonel)</label>
                            <input type="text" @bind="kurumAdi" class="form-control form-control-lg bg-light" placeholder="Varsa kurumunuz">
                        </div>

                        <div class="col-12">
                            <label class="form-label fw-bold text-secondary">Bağışlamak İstediğiniz Tutar (₺)</label>
                            <div class="input-group input-group-lg">
                                <span class="input-group-text bg-success text-white fw-bold">₺</span>
                                <input type="number" @bind="miktar" class="form-control bg-light" placeholder="Örn: 5000">
                            </div>
                            <div class="form-text mt-2"><i class="bi bi-info-circle"></i> Bağışınız doğrudan burs havuzuna aktarılacaktır.</div>
                        </div>

                        <div class="col-12 mt-4">
                            <button class="btn btn-primary btn-lg w-100 py-3 fw-bold shadow hover-scale" @onclick="BursuKaydet">
                                BAŞVURUYU TAMAMLA <i class="bi bi-arrow-right-circle ms-2"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@code {
    // Başlangıç değerlerini boş veriyoruz ki sayfa açılırken "NullReference" hatası verip beyaz ekran yapmasın.
    private string adSoyad = "";
    private string kurumAdi = "";
    private string eposta = "";
    private string telefon = "";
    private string mesaj = "";
    private decimal miktar = 0;

    // KRİTİK NOKTA: TrustServerCertificate=True ve Encrypt=False ekledik!
    // Bu sayede "SSL Provider" hatası almadan LocalDB'ye bağlanacak.
    string connectionString = @"Data Source=(localdb)\MSSQLLocalDB; initial catalog=bursOtoDeneme1; Integrated Security=TRUE; Encrypt=False; TrustServerCertificate=True;";

    private bool IsErrorMessage =>
        !string.IsNullOrEmpty(mesaj) && mesaj.StartsWith("Hata");

    private void BursuKaydet()
    {
        // Basit bir validasyon (boş alan kontrolü)
        if (string.IsNullOrWhiteSpace(adSoyad) || string.IsNullOrWhiteSpace(telefon) || miktar <= 0)
        {
            mesaj = "Hata: Lütfen Ad Soyad, Telefon ve geçerli bir Tutar giriniz.";
            return;
        }

        try
        {
            using (SqlConnection conn = new SqlConnection(connectionString))
            {
                conn.Open();

                // SQL Sorgusu: Tablo adının ve sütunların veritabanındakiyle aynı olduğuna emin ol.
                string query = "INSERT INTO BursVerenler (AdSoyad, KurumAdı, BagisMiktari, Eposta, Telefon, Durum) VALUES (@p1, @p2, @p3, @p4, @p5, 'Beklemede')";

                using (SqlCommand cmd = new SqlCommand(query, conn))
                {
                    cmd.Parameters.AddWithValue("@p1", adSoyad);
                    cmd.Parameters.AddWithValue("@p2", kurumAdi); // Boşsa boş string gider
                    cmd.Parameters.AddWithValue("@p3", miktar);
                    cmd.Parameters.AddWithValue("@p4", eposta);
                    cmd.Parameters.AddWithValue("@p5", telefon);

                    cmd.ExecuteNonQuery();
                }
            }

            mesaj = "Teşekkürler! Bağış başvurunuz başarıyla alındı. Sizinle iletişime geçeceğiz.";

            // Başarılı olursa kutuları temizle
            adSoyad = ""; kurumAdi = ""; eposta = ""; telefon = ""; miktar = 0;
        }
        catch (Exception ex)
        {
            // Hata mesajını ekrana basıyoruz ki sorunu görelim
            mesaj = "Hata: Bağış kaydedilirken bir sorun oluştu. Lütfen daha sonra tekrar deneyin.";
        }
    }
}